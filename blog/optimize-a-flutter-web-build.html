<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Optimize a Flutter web build</title>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Nunito"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css"
    />

    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Nunito"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/dart.min.js"></script>
    <script>
      hljs.highlightAll();
    </script>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-HJHXZM0ZQ1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-HJHXZM0ZQ1');
</script>

    <style type="text/tailwindcss">
      @layer utilities {
        html {
          @apply tracking-wide text-lg;
        }
        .code {
          @apply bg-gray-200 px-2 rounded-lg;
        }

        p {
          @apply mb-4;
        }

        h2 {
          @apply text-4xl font-semibold text-gray-800 my-8;
        }
        h3 {
          @apply text-xl font-semibold text-gray-800 my-4;
        }
        a {
          @apply text-blue-600 font-semibold;
        }
      }
    </style>
  </head>
  <body class="flex flex-col pb-20">
    <nav
      class="sticky top-0 mb-10 h-20 shadow border-bottom-2 z-10 bg-blue-600 text-white flex items-center px-8"
    >
      <div class="w-full sm:w-3/5 sm:mx-auto flex justify-between">
        <a href="/" class="text-white">Home</a>

        <div class="flex gap-4">
          <a
            href="https://twitter.com/clementbdev"
            target="_blank"
            class="text-white"
            >Twitter</a
          >
          <a
            href="https://github.com/ClementBeal"
            target="_blank"
            class="text-white"
            >Github</a
          >
        </div>
      </div>
    </nav>
    <main class="p-4 w-full sm:w-3/5 mx-auto border border-red border-1 p-8 rounded-lg">
      <h1 class="text-5xl font-bold text-center mb-8 text-gray-800">
        Optimize a Flutter web build
      </h1>

      <hr class="mb-8" />

      <p>
        Few weeks ago, I was working on porting my Flutter app to the web. It's
        a very straight-forward operation. I just needed to add the <code class="code">web</code>
        platform, build and done! Then I remembered that a lot of people were
        complaining about the Flutter's web build. The main complain is the app
        (or web app) has to download a huge javascript file the first time a
        user load the app. This javascript file <code class="code">main.dart.js</code> weights 2.5MB at
        least!
      </p>

      <p>
        Once you start to read this <code class="code">main.dart.js</code>, we can notice that we can
        make some optimization here and there to reduce the total size of the
        file. I started to have fun trying to find ways to reduce its size. It's
        what I'm going to do with you now!
      </p>

      <p>
        I'll use Python to write a script to reduce the total size of the
        <code class="code">main.dart.js</code>. I'll compare the final size with the original size and
        because this file is compressed when transferred, I'll also compress the
        final file with <code class="code">gzip</code> and make a comparaison.
      </p>

      <p>Let's first generate the flutter project</p>

      <pre><code>flutter create --platforms web -t skeleton my_app</code></pre>

      <p>
        Then build it for the CanvasKit renderer with the most aggressive
        Javascript optimizations.
      </p>

      <pre><code>flutter build web --release --web-renderer canvaskit --dart2js-optimization O4</code></pre>

      <p>
        The current size is <code class="code">1 871 623</code> bytes uncompressed and <code class="code">546 031</code>
        compressed.
      </p>

      <div class="p-8 bg-red-200 rounded-lg">
        <p>
          I'm doing this experiment with the help of regex. Therefore some
          optimizations are harder this way than with an AST tree. Some of the
          optimizations will not produce the exact output but something very
          close.
        </p>
      </div>

      <h2>Quick dart optimizations</h2>

      <h3>Replace true/false with !0/!1</h3>

      <p>
        There still are some <code class="code">true</code>/</code>false</code> literals in the final code. In
        javascript, <code class="code">!0/!1</code> is respectivally equivalent to <code class="code">true/false</code>.
      </p>

      <h3>Remove indentation</h3>

      <p>
        A little part of the code still has indentation. Let's find that with
        the regex <code class="code">^\s+</code> and replace the matches with empty strings.
      </p>

      <h3>Empty constructor</h3>

      <p>
        In Javascript, if we have an empty constructor like <code class="code">new A()</code>, we can
        remove the parentheses.
      </p>

      <h2>Number representations</h2>

      <h3>Use fractions</h3>

      <p>
        Some decimal numbers can be written as a fraction. For instance, we
        could write 1/3 instead of 0.33333333333333... We have to check if the
        len of the fraction is smaller than the current decimal number otherwise
        nothing changes.
      </p>

      <h3>Decimal leading zero</h3>

      <p>
        If the integer part of the number is 0, we remove it and only keep the
        dot and the decimal part. One byte saved!
      </p>

      <code class="code">0.93849</code> -> <code class="code">.93849</code>

      <h3>Multiplication by 0</h3>

      <p>
        We can find some multiplication by 0. We can remove them peacefully and
        save some few more bytes.
      </p>

      <h3>Shorten the float length</h3>

      <p>
        It can be risky but let's try it for the experience. We cut off the
        decimals after the 8th decimal.
      </p>

      <code class="code">3.14159265359</code> ->
      <code class="code">3.14159265</code>

      <h3>Use scientist notation (not implemented)</h3>

      <p>
        The idea is to convert numbers multiplicated by a power of 10 into the
        notation <code class="code">eXXX</code>.<br />
        Examples:
      </p>
      <code class="code">5241330000</code> ->
      <code class="code">524133e4</code>
      <code class="code">0.0001</code> -><code class="code"></code>1e-4</code>

      <h2>Optimizations that are finally not optimizations</h2>

      <p>
        The following optimizations produce a JS code that is shorter but the
        gzip output is bigger. After the fact, I realized I was doing the job of
        a compressing algorithm but in a worse way. For this reason, I do not
        add them to the optimization chain.
      </p>

      <h3>Reduce null arguments array</h3>

      <p>
        There's lot of functions having plenty of successive
        <code class="code">null</code> as arguments like this:
      </p>

      <pre><code>B.Z3=new A.o(!0,B.A,null,"Roboto",B.E,null,null,null,null,null,null,null,null,null,null,null,null,B.e,null,null,null,"blackHelsinki displayLarge",null,null,null,null)</code></pre>

      <p>
        The idea is to use the spread operator <code class="code">...</code> on
        an Array of null: <code class="code">...Array(5).fill(null)</code>
      </p>

      <h3>Flip null condition</h3>

      <p>
        An idea I've borrowed from a JS minifier (I guess babel). They suppose
        that <code class="code">if(a==null)</code> could be change into <code class="code">if(null=a)</code> and the <code class="code">gzip</code>
        algorithm will have better compression. In my case, it makes the
        compression slightly worse. I would like to retry this one with the AST
        tree to be sure that my conclusion is correct
      </p>

      <h3>Gather the literals into variables</h3>

      <p>
        The goal is to capture all the literals (booleans, strings, numbers),
        count the number of occurences and store the most common ones into
        variables. If we have a lot of <code class="code">3.14159265359</code>, we store it into the
        variable <code class="code">aaa</code> and replace all the occurences of <code class="code">3.14159265359</code> with
        <code class="code">aaa</code>.
      </p>

      <h2>Conditions</h2>

      <h3>Remove some dead null condition</h3>

      <p>
        We can find this type of condition <code class="code">s==null?null:s</code>. It could simply be
        <code class="code">s</code>.
      </p>

      <h3>Transform <code class="code">x === 0</code> or <code class="code">x !== 0</code></h3>

      <p>
        Let's use the fact that <code class="code">0</code> combined with the <code class="code">!</code> operator returns
        <code class="code">true</code> and anything else returns <code class="code">false</code>.
      </p>

      <p>
        We would rewrite:<br />
        <code class="code">x === 0</code> into <code class="code">!x</code><br />
        <code class="code">x !== 0</code> into <code class="code">!!x</code>
      </p>

      <p>
        This optimization is also an aproximation and so is not totally correct.
        The output is not correct javascript but the number of chars are equals.
      </p>

      <h3>Ternary condition</h3>

      <p>
        There's differents micro optimizations possible for the ternary
        condition. Let's do it in this case :
      </p>

      <code class="code">a == null ? 23: a</code> -> <code class="code">a ?? 23</code>

      <h3>Nullish coalescing assigment operator <code class="code">??=</code></h3>

      <code class="code">if(a==null) a = 3</code> could be <code class="code">a ??= 3</code>

      <h2>Manual optimizations linked to Flutter</h2>

      <p>
        Those optimizations are probably not producing correct code but I
        believe it's a way to to reduce drastically the code size.
      </p>

      <p>
        Flutter provides a system to make the font renderer working for any
        language. You will have fonts for english like language but also for
        chinese, arabic, japanese, thai, etc... Your app is probably not
        translating or displaying these languages. We can try to remove some of
        them.
      </p>

      <p>
        We save 15kB when we remove the fallback fonts like <code class="code">Noto Sans
        Adlam</code>.<br />
        Then we could imagine a smart optimization removing the text theme for
        the non-english languages. This block alone is about 2.5kB.
      </p>

      <pre>
  <code>
    B.a_2=new A.o(!1,null,null,null,null,null,57,B.B,null,-0.25,null,B.C,1.12,B.r,null,null,null,null,null,null,null,"tall displayLarge 2021",null,null,null,null)
    B.Z9=new A.o(!1,null,null,null,null,null,45,B.B,null,0,null,B.C,1.16,B.r,null,null,null,null,null,null,null,"tall displayMedium 2021",null,null,null,null)
    B.YB=new A.o(!1,null,null,null,null,null,36,B.B,null,0,null,B.C,1.22,B.r,null,null,null,null,null,null,null,"tall displaySmall 2021",null,null,null,null)
    B.a_i=new A.o(!1,null,null,null,null,null,32,B.B,null,0,null,B.C,1.25,B.r,null,null,null,null,null,null,null,"tall headlineLarge 2021",null,null,null,null)
    B.a_c=new A.o(!1,null,null,null,null,null,28,B.B,null,0,null,B.C,1.29,B.r,null,null,null,null,null,null,null,"tall headlineMedium 2021",null,null,null,null)
    B.Zq=new A.o(!1,null,null,null,null,null,24,B.B,null,0,null,B.C,1.33,B.r,null,null,null,null,null,null,null,"tall headlineSmall 2021",null,null,null,null)
    B.Xe=new A.o(!1,null,null,null,null,null,22,B.B,null,0,null,B.C,1.27,B.r,null,null,null,null,null,null,null,"tall titleLarge 2021",null,null,null,null)
    B.a_3=new A.o(!1,null,null,null,null,null,16,B.ad,null,0.15,null,B.C,1.5,B.r,null,null,null,null,null,null,null,"tall titleMedium 2021",null,null,null,null)
    B.XT=new A.o(!1,null,null,null,null,null,14,B.ad,null,0.1,null,B.C,1.43,B.r,null,null,null,null,null,null,null,"tall titleSmall 2021",null,null,null,null)
    B.Xb=new A.o(!1,null,null,null,null,null,16,B.B,null,0.5,null,B.C,1.5,B.r,null,null,null,null,null,null,null,"tall bodyLarge 2021",null,null,null,null)
    B.Zd=new A.o(!1,null,null,null,null,null,14,B.B,null,0.25,null,B.C,1.43,B.r,null,null,null,null,null,null,null,"tall bodyMedium 2021",null,null,null,null)
    B.Z_=new A.o(!1,null,null,null,null,null,12,B.B,null,0.4,null,B.C,1.33,B.r,null,null,null,null,null,null,null,"tall bodySmall 2021",null,null,null,null)
    B.Zp=new A.o(!1,null,null,null,null,null,14,B.ad,null,0.1,null,B.C,1.43,B.r,null,null,null,null,null,null,null,"tall labelLarge 2021",null,null,null,null)
    B.Zc=new A.o(!1,null,null,null,null,null,12,B.ad,null,0.5,null,B.C,1.33,B.r,null,null,null,null,null,null,null,"tall labelMedium 2021",null,null,null,null)
    B.XV=new A.o(!1,null,null,null,null,null,11,B.ad,null,0.5,null,B.C,1.45,B.r,null,null,null,null,null,null,null,"tall labelSmall 2021",null,null,null,null)
    B.a_n=new A.cY(B.a_2,B.Z9,B.YB,B.a_i,B.a_c,B.Zq,B.Xe,B.a_3,B.XT,B.Xb,B.Zd,B.Z_,B.Zp,B.Zc,B.XV)
  </code>
</pre>

      <h2>Result</h2>

      <p>Let's run the script:</p>

      <pre>
  <code>
    Initial size : 1,871,623
    Initial compressed size : 541,494
    --------------
    true_false_optimizer -> 408
    indentation_optimizer -> 363
    empty_constructor_optimizer -> 1368
    fraction_optimizer -> 0
    float_leading_zero_optimizer -> 280
    multiplication_zero_optimizer -> 32
    nullish_coalescing_assignment_optimizer -> 4342
    useless_null_condition_optimizer -> 273
    equal_0_condition_optimizer -> 2255
    comma_endline_optimizer -> 11274
    reduce_float_length -> 235
    ternary_condition_optimizer -> 6271
  
    -------------
  
    We saved  27,101 bytes
    Compressed : 538,547
  </code>
</pre>

      <p>
        It's a gain of <code class="code">~3kB</code> or <code class="code">0.5%</code> for the compressed file. That's...
        nothing....
      </p>

      <p>
        But now I apply the manual optimizations and we save <code class="code">~6kB</code> so <code class="code">~1%</code>.
        Still nothing!
      </p>

      <h2>Can we do better?</h2>

      <p>
        In terms of tricky Javascript code optimizations, I am not sure. If we
        speak about the Flutter code converted into JS, yes.
      </p>

      <p>First, I believe we can do something with the enums.</p>

      <ul class="list-disc">
      <li>
        LogicalKeyboardKey: 11.5kB of data Every key of the keyboard is mapped,
        even some that you might not think to use. I have discovered the keys
        <code class="code">Zenkaku</code> and <code class="code">ZenkakuHankaku</code> which are used by the Japanese keyboards.
        Or <code class="code">TVInputHDMI1</code>; <code class="code">TVInputHDMI2</code>; <code class="code">TVInputHDMI3</code> that I believe are
        buttons from your TV remotes.
      </li>
      <li>
        AutofillHints : at least 1.5kB I'm not
        using the Autofill but I still have the code for the hint
        <code class="code">streetAddressLevel4</code>.
      </li>
    </ul>
      <p>Then the localization of the app.</p>

      <pre>
  <code>
    localizationsDelegates: const [
        AppLocalizations.delegate,
        GlobalMaterialLocalizations.delegate,
        GlobalWidgetsLocalizations.delegate,
        GlobalCupertinoLocalizations.delegate,
    ],
    supportedLocales: const [
        Locale('en', ''), // English, no country code
    ],
  </code>
</pre>

      <p>
        We define here we only support english but we still import every
        localization for every possible languages. In our example app, it's
        about 130kB. It's probably the responsability of the developers to only
        import the localization he needs.
      </p>

      <p>
        Finally, the developers can write write Dart code that will be generated
        in a better way for the web. From my observations, <code class="code">dart2js</code> will
        translate your Dart code into the same JS code without doing much
        optimizations. If you write really clean code, it will not be translated
        in something more obscure but not shorter.
      </p>

      <h2>Is my code useful?</h2>

      <p>
        It may be a bit useful for the <code class="code">dartdevc</code> compiler. It's another dart
        compiler for the web used by <code class="code">api.flutter.dev</code>.
      </p>

      <p>
        If you go on this page
        <a
          href="https://api.flutter.dev/flutter/material/FilledButton-class.html"
          >https://api.flutter.dev/flutter/material/FilledButton-class.html</a
        >
        and check your network tab, you'll see that you download 16.5MB of
        compressed data (100MB uncompressed).
      </p>

      <p>
        Your browser downloads <code class="code">flutter_web.js</code> (4.26MB) and <code class="code">dart_sdk.js</code>
        (2.05MB). My script reduces their size to <code class="code">4.01MB</code> and <code class="code">1.99MB</code> and make
        them globally smaller (could speed up the parsing by the JS engine)
      </p>

      <p>
        Thanks you for reading this post! It was "fun" to try to find
        optimizations. You can find the code here
        <a
          href="https://gist.github.com/ClementBeal/10ed98576d4069aae74ef6ef11a8788b"
          >https://gist.github.com/ClementBeal/10ed98576d4069aae74ef6ef11a8788b</a
        >
      </p>
    </main>
  </body>
</html>
