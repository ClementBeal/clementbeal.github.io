<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta http-equiv="X-UA-Compatible" content="ie=edge"/><title>Optimize a Flutter web build</title><meta name="description" content="An experiment to make the `main.dart.js` smaller"/><link rel="icon" href="favicon.ico" type="image/x-icon"/><link rel="stylesheet" href="/assets/style.css"/><style></style><link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&amp;display=swap" rel="stylesheet"/><script src="https://cdn.tailwindcss.com"></script><!-- For color syntax --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css"/><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/dart.min.js"></script><script>hljs.highlightAll();</script></head><body class="flex flex-col pb-20"><nav class="sticky top-0 mb-10 h-20 shadow border-bottom-2 z-10 bg-blue-600 text-white flex items-center px-8"><div class="w-full sm:w-3/5 sm:mx-auto flex justify-between"><div class="flex gap-4"><a href="/" class="text-white">Home</a><a href="/projects" class="text-white">Projects</a><a href="/posts" class="text-white">Blog</a></div><div class="flex gap-4"><a href="https://twitter.com/clementbdev" target="_blank" class="text-white">Twitter</a><a href="https://github.com/ClementBeal" target="_blank" class="text-white">Github</a><a href="/rss.xml" class="text-white" target="_blank">RSS</a></div></div></nav><main class="sm:w-3/5 mx-auto border border-1 p-8 rounded-lg gap-4"><div class="markdown-content"><h1>Optimize a Flutter Web Build</h1><hr/><p>A few weeks ago, I was working on porting my Flutter app to the web. It's a very straightforward operation. I just needed to add the<code>web</code>platform, build, and done! Then, I remembered that a lot of people were complaining about Flutter's web build. The main complaint is that the app (or web app) has to download a huge JavaScript file the first time a user loads the app. This JavaScript file<code>main.dart.js</code>weighs 2.5MB at least!</p><p>Once you start to read this<code>main.dart.js</code>, we can notice that we can make some optimizations here and there to reduce the total size of the file. I started to have fun trying to find ways to reduce its size. It's what I'm going to do with you now!</p><p>I'll use Python to write a script to reduce the total size of the<code>main.dart.js</code>. I'll compare the final size with the original size and because this file is compressed when transferred, I'll also compress the final file with<code>gzip</code>and make a comparison.</p><p>Let's first generate the Flutter project:</p><pre><code class="language-bash">flutter create --platforms web -t skeleton my_app</code></pre><p>Then, build it for the CanvasKit renderer with the most aggressive JavaScript optimizations.</p><pre><code class="language-bash">flutter build web --release --web-renderer canvaskit --dart2js-optimization O4</code></pre><p>The current size is<code>1 871 623</code>bytes uncompressed and<code>546 031</code>compressed.</p><blockquote><p>I'm doing this experiment with the help of regex. Therefore, some optimizations are harder this way than with an AST tree. Some of the optimizations will not produce the exact output but something very close.</p></blockquote><h2>Quick Dart Optimizations</h2><h3>Replace true/false with !0/!1</h3><p>There still are some<code>true</code>/<code>false</code>literals in the final code. In JavaScript,<code>!0</code>/<code>!1</code>is respectively equivalent to<code>true</code>/<code>false</code>.</p><h3>Remove Indentation</h3><p>A little part of the code still has indentation. Let's find that with the regex<code>^\s+</code>and replace the matches with empty strings.</p><h3>Empty Constructor</h3><p>In JavaScript, if we have an empty constructor like<code>new A()</code>, we can remove the parentheses.</p><h2>Number Representations</h2><h3>Use Fractions</h3><p>Some decimal numbers can be written as fractions. For instance, we could write 1/3 instead of 0.33333333333333... We have to check if the length of the fraction is smaller than the current decimal number otherwise nothing changes.</p><h3>Decimal Leading Zero</h3><p>If the integer part of the number is 0, we remove it and only keep the dot and the decimal part. One byte saved!</p><p><code>0.93849</code>-><code>.93849</code></p><h3>Multiplication by 0</h3><p>We can find some multiplication by 0. We can remove them peacefully and save a few more bytes.</p><h3>Shorten the Float Length</h3><p>It can be risky but let's try it for the experience. We cut off the decimals after the 8th decimal.</p><p><code>3.14159265359</code>-><code>3.14159265</code></p><h3>Use Scientific Notation (Not Implemented)</h3><p>The idea is to convert numbers multiplied by a power of 10 into the notation<code>eXXX</code>.</p><p>Examples:</p><ul><li><code>5241330000</code>-><code>524133e4</code></li><li><code>0.0001</code>-><code>1e-4</code></li></ul><h2>Optimizations That Are Finally Not Optimizations</h2><p>The following optimizations produce a JS code that is shorter but the gzip output is bigger. After the fact, I realized I was doing the job of a compressing algorithm but in a worse way. For this reason, I do not add them to the optimization chain.</p><h3>Reduce Null Arguments Array</h3><p>There's a lot of functions having plenty of successive<code>null</code>as arguments like this:</p><pre><code class="language-js">B.Z3 = new A.o(!0, B.A, null, "Roboto", B.E, null, null, null, null, null, null, null, null, null, null, null, B.e, null, null, null, "blackHelsinki displayLarge", null, null, null, null)</code></pre><p>The idea is to use the spread operator<code>...</code>on an Array of null:<code>...Array(5).fill(null)</code></p><h3>Flip Null Condition</h3><p>An idea I've borrowed from a JS minifier (I guess Babel). They suppose that<code>if(a==null)</code>could be changed into<code>if(null=a)</code>and the<code>gzip</code>algorithm will have better compression. In my case, it makes the compression slightly worse. I would like to retry this one with the AST tree to be sure that my conclusion is correct.</p><h3>Gather the Literals into Variables</h3><p>The goal is to capture all the literals (booleans, strings, numbers), count the number of occurrences, and store the most common ones into variables. If we have a lot of<code>3.14159265359</code>, we store it into the variable<code>aaa</code>and replace all the occurrences of<code>3.14159265359</code>with<code>aaa</code>.</p><h2>Conditions</h2><h3>Remove Some Dead Null Condition</h3><p>We can find this type of condition<code>s==null?null:s</code>. It could simply be<code>s</code>.</p><h3>Transform<code>x === 0</code>or<code>x !== 0</code></h3><p>Let's use the fact that<code>0</code>combined with the<code>!</code>operator returns<code>true</code>and anything else returns<code>false</code>.</p><p>We would rewrite:</p><ul><li><code>x === 0</code>into<code>!x</code></li><li><code>x !== 0</code>into<code>!!x</code></li></ul><p>This optimization is also an approximation and so is not totally correct. The output is not correct JavaScript but the number of chars are equal.</p><h3>Ternary Condition</h3><p>There are different micro-optimizations possible for the ternary condition. Let's do it in this case:</p><p><code>a == null ? 23: a</code>-><code>a ?? 23</code></p><h3>Nullish Coalescing Assignment Operator<code>??=</code></h3><p><code>if(a==null) a = 3</code>could be<code>a ??= 3</code></p><h2>Manual Optimizations Linked to Flutter</h2><p>Those optimizations are probably not producing correct code but I believe it's a way to drastically reduce the code size.</p><p>Flutter provides a system to make the font renderer work for any language. You will have fonts for English-like languages but also for Chinese, Arabic, Japanese, Thai, etc. Your app is probably not translating or displaying these languages. We can try to remove some of them.</p><p>We save 15kB when we remove the fallback fonts like<code>Noto Sans Adlam</code>. Then, we could imagine a smart optimization removing the text theme for the non-English languages. This block alone is about 2.5kB.</p><pre><code class="language-js">B.a_2 = new A.o(!1, null, null, null, null, null, 57, B.B, null, -0.25, null, B.C, 1.12, B.r, null, null, null, null, null, null, "tall displayLarge 2021", null, null, null, null)
B.Z9 = new A.o(!1, null, null, null, null, null, 45, B.B, null, 0, null, B.C, 1.16, B.r, null, null, null, null, null, null, "tall displayMedium 2021", null, null, null, null)
B.YB = new A.o(!1, null, null, null, null, null, 36, B.B, null, 0, null, B.C, 1.22, B.r, null, null, null, null, null, null, "tall displaySmall 2021", null, null, null, null)
B.a_i = new A.o(!1, null, null, null, null, null, 32, B.B, null, 0, null, B.C, 1.25, B.r, null, null, null, null, null, null, "tall headlineLarge 2021", null, null, null, null)
B.a_c = new A.o(!1, null, null, null, null, null, 28, B.B, null, 0, null, B.C, 1.29, B.r, null, null, null, null, null, null, "tall headlineMedium 2021", null, null, null, null)
B.Zq = new A.o(!1, null, null, null, null, null, 24, B.B, null, 0, null, B.C, 1.33, B.r, null, null, null, null, null, null, "tall headlineSmall 2021", null, null, null, null)
B.Xe = new A.o(!1, null, null, null, null, null, 22, B.B, null, 0, null, B.C, 1.27, B.r, null, null, null, null, null, null, "tall titleLarge 2021", null, null, null, null)
B.a_3 = new A.o(!1, null, null, null, null, null, 16, B.ad, null, 0.15, null, B.C, 1.5, B.r, null, null, null, null, null, null, "tall titleMedium 2021", null, null, null, null)
B.XT = new A.o(!1, null, null, null, null, null, 14, B.ad, null, 0.1, null, B.C, 1.43, B.r, null, null, null, null,

 null, null, "tall titleSmall 2021", null, null, null, null)
B.Yt = new A.o(!1, null, null, null, null, null, 12, B.ad, null, 0.4, null, B.C, 1.5, B.r, null, null, null, null, null, null, "tall labelLarge 2021", null, null, null, null)
B.a_y = new A.o(!1, null, null, null, null, null, 11, B.ad, null, 0.5, null, B.C, 1.45, B.r, null, null, null, null, null, null, "tall labelMedium 2021", null, null, null, null)
B.Zk = new A.o(!1, null, null, null, null, null, 10, B.ad, null, 0.5, null, B.C, 1.4, B.r, null, null, null, null, null, null, "tall labelSmall 2021", null, null, null, null)
B.Wu = new A.o(!1, null, null, null, null, null, 16, B.F, null, null, null, B.C, 1.75, B.w, null, null, null, null, null, null, "tall bodyLarge 2021", null, null, null, null)
B.Ym = new A.o(!1, null, null, null, null, null, 14, B.F, null, null, null, B.C, 1.5, B.w, null, null, null, null, null, null, "tall bodyMedium 2021", null, null, null, null)
B.a_w = new A.o(!1, null, null, null, null, null, 12, B.F, null, null, null, B.C, 1.45, B.w, null, null, null, null, null, null, "tall bodySmall 2021", null, null, null, null)</code></pre><p>Removing it and a few other styles we can gain about 50kB.</p><h2>Conclusion</h2><p>By running all the optimizations, we can gain about 10kB in total. I believe more advanced optimizations could be achieved if the logic were to be done with an AST parser instead of regex. It's also easy to break the code with regex because the JavaScript syntax is quite tricky.</p><p>That was a fun experiment that probably inspired me to do something similar but with the help of an AST tree and ESBuild. The experiment ends here and I hope you learned something today.</p></div></main></body></html>